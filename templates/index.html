<script>
  const termsCheck = document.getElementById("termsCheck");
  const fileUpload = document.getElementById("fileUpload");
  const formatSelect = document.getElementById("format");
  const uploadBtn = document.getElementById("uploadBtn");
  const form = document.getElementById("uploadForm");
  const overlay = document.getElementById("loaderOverlay");
  const msgBox = overlay.querySelector(".msg");

  termsCheck.addEventListener("change", function() {
    const enabled = this.checked;
    fileUpload.disabled = !enabled;
    formatSelect.disabled = !enabled;
    uploadBtn.disabled = !enabled;
  });

  form.addEventListener("submit", async function(e) {
    e.preventDefault();

    overlay.style.display = "flex";
    msgBox.style.color = "#0077cc";   // normal blue
    msgBox.textContent = "Processing your file… please wait.";

    const formData = new FormData(form);

    try {
      const response = await fetch("{{ url_for('convert') }}", {
        method: "POST",
        body: formData,
        headers: {
          "Accept": "application/json"
        }
      });

      if (!response.ok) {
        // Server returned an error
        const data = await response.json().catch(() => ({}));
        msgBox.style.color = "red";
        msgBox.textContent = data.error || `❌ Conversion failed (status ${response.status}).`;
        return;
      }

      // If success → get file blob
      const blob = await response.blob();
      const disposition = response.headers.get("Content-Disposition") || "";
      let filename = "converted-file";
      const match = disposition.match(/filename="?([^"]+)"?/);
      if (match) filename = match[1];

      // Create download link
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      msgBox.style.color = "green";
      msgBox.textContent = "✅ Conversion complete! Your download has started.";

      setTimeout(() => {
        overlay.style.display = "none";
      }, 4000);

    } catch (err) {
      msgBox.style.color = "red";
      msgBox.textContent = `❌ Error: ${err.message}`;
    }
  });
</script>
