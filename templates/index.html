<!DOCTYPE html>
<html>
<head>
  <title>CleanCopy OCR</title>
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; }
    .upload-box { border: 2px dashed #999; padding: 20px; text-align: center; }
    .progress { width: 100%; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 20px; }
    .progress-bar { width: 0%; height: 20px; background: #4caf50; transition: width 0.3s; }
    #status { margin-top: 10px; }
    button { margin-top: 15px; padding: 10px 20px; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>üìÑ CleanCopy OCR</h1>
  <form id="uploadForm" method="POST" enctype="multipart/form-data" action="/upload">
    <div class="upload-box">
      <input type="file" name="fileUpload" required>
    </div>
    <label>
      <input type="checkbox" name="terms" required>
      I agree to the <a href="/terms" target="_blank">terms of service</a> and <a href="/privacy" target="_blank">privacy policy</a>.
    </label><br><br>
    <label>Output format:
      <select name="format">
        <option value="docx">DOCX</option>
        <option value="txt">TXT</option>
      </select>
    </label><br><br>
    <button type="submit">Upload & Convert</button>
  </form>

  <div id="progress" style="display:none;">
    <div class="progress"><div id="bar" class="progress-bar"></div></div>
    <p id="status">Uploading...</p>
    <button id="cancelBtn" type="button">‚úñ Cancel</button>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const progress = document.getElementById("progress");
    const bar = document.getElementById("bar");
    const status = document.getElementById("status");
    const cancelBtn = document.getElementById("cancelBtn");
    let currentJobId = null;
    let pollInterval = null;

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      progress.style.display = "block";
      status.innerText = "Uploading...";
      bar.style.width = "10%";

      const res = await fetch("/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();

      if (data.error) {
        status.innerText = "‚ùå " + data.error;
        return;
      }

      currentJobId = data.job_id;
      status.innerText = "Processing...";
      bar.style.width = "40%";

      pollInterval = setInterval(checkStatus, 5000);
    });

    async function checkStatus() {
      if (!currentJobId) return;
      const res = await fetch(`/status/${currentJobId}`);
      const data = await res.json();

      if (data.status === "processing") {
        status.innerText = "Processing...";
        bar.style.width = (parseInt(bar.style.width) + 10) % 90 + "%";
      }
      else if (data.status === "finished") {
        clearInterval(pollInterval);
        status.innerText = "‚úÖ Done! Download ready.";
        bar.style.width = "100%";
        window.location = data.download_url;
      }
      else if (data.status === "failed") {
        clearInterval(pollInterval);
        status.innerText = "‚ùå Failed: " + data.error;
        bar.style.width = "0%";
      }
    }

    cancelBtn.addEventListener("click", async function() {
      if (!currentJobId) return;
      await fetch(`/cancel/${currentJobId}`, { method: "POST" });
      clearInterval(pollInterval);
      status.innerText = "‚ùå Conversion cancelled.";
      bar.style.width = "0%";
    });
  </script>
</body>
</html>
